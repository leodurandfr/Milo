#!/bin/bash
# Milo Client - Secure Snapclient Installation Wrapper
# Only allows installing validated snapclient .deb packages
set -euo pipefail

error_exit() { echo "ERROR: $1" >&2; exit 1; }

[ $# -ne 1 ] && error_exit "Usage: $0 <path-to-snapclient-deb>"

DEB_PATH="$1"

# Validate file exists
[ ! -f "$DEB_PATH" ] && error_exit "File does not exist: $DEB_PATH"

# Validate absolute path
[[ "$DEB_PATH" != /* ]] && error_exit "Path must be absolute"

# Validate in temp directory only
case "$DEB_PATH" in
    /tmp/*|/var/tmp/*) ;;
    *) error_exit "DEB file must be in /tmp or /var/tmp" ;;
esac

# Validate .deb extension
[[ "$DEB_PATH" != *.deb ]] && error_exit "File must have .deb extension"

# Validate filename pattern (snapclient releases)
FILENAME=$(basename "$DEB_PATH")
if ! [[ "$FILENAME" =~ ^snapclient_[0-9]+\.[0-9]+\.[0-9]+-[0-9]+_arm64_(bookworm|trixie|bullseye|buster)\.deb$ ]]; then
    error_exit "Filename does not match snapclient pattern: $FILENAME"
fi

# Validate package name inside .deb
PACKAGE_NAME=$(dpkg-deb --show --showformat='${Package}' "$DEB_PATH" 2>/dev/null) || \
    error_exit "Failed to read package info"
[ "$PACKAGE_NAME" != "snapclient" ] && error_exit "Package is not snapclient: $PACKAGE_NAME"

# Update package lists and install
DEBIAN_FRONTEND=noninteractive apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends "$DEB_PATH"
